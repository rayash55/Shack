<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Holiday Home Booking</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Nicer font -->
<link rel="stylesheet"
  href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap">

<style>
/* ------------------------------------------------------
   GLOBAL BACKGROUND â€“ RIVER PHOTO + NEUTRAL WASH
------------------------------------------------------ */
body {
  font-family: "Poppins", sans-serif;
  margin: 0;

body {
  font-family: "Poppins", sans-serif;
  margin: 0;
  background: #eaf0f4; /* pale blue/grey */
}

/* ------------------------------------------------------
   GLASS MAIN PANEL
------------------------------------------------------ */
.app {
  max-width: 400px;          /* or 360/480, as you prefer */
  margin: 0 auto;
  min-height: 100vh;
  padding: 12px;
  box-sizing: border-box;

  /* Photo now lives INSIDE the box */
  background:
    linear-gradient(
      rgba(255, 255, 255, 0.80),
      rgba(255, 255, 255, 0.90)
    ),
    url("river-bg.jpg");
  background-size: cover;
  background-position: center;

  border-radius: 18px;
  border: 1px solid rgba(255,255,255,0.6);
  box-shadow: 0 10px 30px rgba(0,0,0,0.12);
  overflow: hidden; /* keeps the photo clipped to the rounded box */
}

/* ------------------------------------------------------
   HEADERS / TEXT
------------------------------------------------------ */
h1 {
  text-align: center;
  font-size: 1.4rem;
  margin-bottom: 4px;
  font-weight: 600;
}

.subtitle {
  text-align: center;
  font-size: 0.88rem;
  color: #333;
  margin-bottom: 10px;
}

.welcome {
  text-align: center;
  margin-bottom: 16px;
  font-size: 1rem;
  font-weight: 500;
}

/* ------------------------------------------------------
   TOP BAR â€“ USER NAME + CHANGE BUTTON
------------------------------------------------------ */
.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 14px;
}

.user-name span {
  font-weight: 600;
}

.colour-preview {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  border: 1px solid #999;
  display: inline-block;
  margin-left: 4px;
}

/* ------------------------------------------------------
   PROPERTY SELECTOR â€“ GLASSY + MINI BUTTONS
------------------------------------------------------ */
.property-bar {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 14px;
}

.property-label {
  font-size: 0.9rem;
  font-weight: 500;
}

.property-select {
  flex: 1;
  padding: 10px 12px;
  font-size: 1rem;
  border-radius: 10px;
  border: 1px solid #ccc;
  background: rgba(255,255,255,0.8);
}

.prop-mini-btn {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  font-size: 18px;
  font-weight: 600;
  border: 1px solid #bbb;
  background: rgba(255,255,255,0.65);
  backdrop-filter: blur(4px);
  cursor: pointer;

  display: flex;
  align-items: center;
  justify-content: center;
}

.prop-del {
  background: rgba(255,235,235,0.7);
  border-color: #d4a4a4;
  color: #a33;
}

.prop-mini-btn:active {
  transform: scale(0.88);
}

/* ------------------------------------------------------
   MONTH NAVIGATION
------------------------------------------------------ */
.month-nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.month-center {
  flex: 1;
  display: flex;
  justify-content: center;
  gap: 6px;
}

.month-select {
  min-width: 120px;
  padding: 6px;
  border-radius: 8px;
}

.year-input {
  width: 70px;
  text-align: center;
  padding: 6px;
  border-radius: 8px;
}

/* ------------------------------------------------------
   VIEW TOGGLE
------------------------------------------------------ */
.view-toggle {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-bottom: 12px;
}

.view-btn {
  padding: 6px 14px;
  border-radius: 999px;
  border: 1px solid #aaa;
  background: rgba(255,255,255,0.6);
  cursor: pointer;
  font-size: 0.85rem;
}

.view-btn-active {
  background: #0078ff;
  border-color: #0078ff;
  color: #fff;
}

/* ------------------------------------------------------
   CALENDAR CELLS
------------------------------------------------------ */
.calendar {
  width: 100%;
  border-collapse: collapse;
}

.calendar th {
  font-size: 0.75rem;
  padding-bottom: 4px;
  color: #444;
}

.calendar td {
  width: 14%;
  height: 54px;
  border: 1px solid rgba(255,255,255,0.4);
  background: rgba(255,255,255,0.20);  /* very light glass */
  backdrop-filter: blur(3px);
}

/* Day button inside the cell */
.day-btn {
  width: 100%;
  height: 100%;
  border: none;
  background: transparent;

  display: flex;
  flex-direction: column;
  justify-content: center;
  cursor: pointer;

  font-size: 0.82rem;
}

.day-number {
  font-weight: 600;
  margin-bottom: 2px;
}

.booking-badge {
  font-size: 0.65rem;
  padding: 2px 4px;
  border-radius: 999px;
  background: rgba(255,255,255,0.7);
  color: #222;
}

/* ------------------------------------------------------
   YEAR VIEW MINI GRIDS
------------------------------------------------------ */
#yearView { display: none; }

.year-grid {
  display: grid;
  grid-template-columns: repeat(2,1fr);
  gap: 10px;
}

.year-month {
  background: rgba(255,255,255,0.6);
  border: 1px solid rgba(0,0,0,0.08);
  border-radius: 8px;
  padding: 6px;
}

.year-month-title {
  font-size: 0.78rem;
  font-weight: 600;
  text-align: center;
  margin-bottom: 4px;
}

.calendar-mini {
  width: 100%;
  border-collapse: collapse;
}

.calendar-mini th {
  font-size: 0.6rem;
}

.calendar-mini td {
  border: 1px solid rgba(0,0,0,0.08);
  height: 30px;
}

/* ------------------------------------------------------
   USER LEGEND
------------------------------------------------------ */
.user-legend {
  text-align: center;
  margin-top: 14px;
  font-size: 0.82rem;
}

.user-legend-item {
  display: inline-flex;
  align-items: center;
  margin: 3px 8px;
  gap: 4px;
}

.user-legend-swatch {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  border: 1px solid #999;
}

/* Buttons general */
button {
  font-family: inherit;
}
</style>
</head>
<body>

<div class="app">
  <h1>Holiday Home Booking</h1>
  <div class="subtitle">Tap a day to book it. Shared between family & friends.</div>
  <div id="welcomeMessage" class="welcome"></div>

  <div class="top-bar">
    <div class="user-name">
      You are: <span id="userNameLabel"></span>
      <span id="userColourPreview" class="colour-preview"></span>
    </div>
    <button id="changeNameBtn">Change</button>
  </div>

  <div class="property-bar">
    <span class="property-label">Property:</span>
    <select id="propertySelect" class="property-select"></select>
    <button id="addPropertyBtn" class="prop-mini-btn">+</button>
    <button id="deletePropertyBtn" class="prop-mini-btn prop-del">âˆ’</button>
  </div>

  <div class="month-nav">
    <button id="prevMonthBtn">â—€</button>
    <div class="month-center">
      <select id="monthSelect" class="month-select"></select>
      <input id="yearInput" type="number" class="year-input">
    </div>
    <button id="nextMonthBtn">â–¶</button>
  </div>

  <div class="view-toggle">
    <button id="viewMonthBtn" class="view-btn view-btn-active">1 Month</button>
    <button id="viewYearBtn" class="view-btn">Year</button>
  </div>

  <div id="monthView">
    <table class="calendar">
      <thead>
        <tr>
          <th>Sun</th><th>Mon</th><th>Tue</th>
          <th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>
        </tr>
      </thead>
      <tbody id="calendarBody"></tbody>
    </table>
  </div>

  <div id="yearView">
    <div class="year-grid" id="yearGrid"></div>
  </div>

  <div id="userLegend" class="user-legend"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ------------------------------------------------------
   ADMIN SETTINGS
------------------------------------------------------ */
const ADMIN_CODE = "1746";

/* ------------------------------------------------------
   FIREBASE INIT
------------------------------------------------------ */
firebase.initializeApp({
  apiKey: "AIzaSyDXdfo2XI7xuHs3LOc6q4CbVpMudHfBTCs",
  authDomain: "ash-shack.firebaseapp.com",
  databaseURL: "https://ash-shack-default-rtdb.firebaseio.com",
  projectId: "ash-shack",
  storageBucket: "ash-shack.firebasestorage.app",
  messagingSenderId: "7831464900",
  appId: "1:7831464900:web:18f1c72f0c37f667005291"
});
const db = firebase.database();

/* ------------------------------------------------------
   STATE
------------------------------------------------------ */
let currentUserName = null;
let currentPropertyId = null;
let bookingsRef = null;
let bookings = {};
let userColours = {};

let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth();
let viewMode = "month";

const MONTH_NAMES=[
  "January","February","March","April","May","June",
  "July","August","September","October","November","December"
];

/* ------------------------------------------------------
   DOM
------------------------------------------------------ */
const userNameLabel=document.getElementById("userNameLabel");
const userColourPreview=document.getElementById("userColourPreview");
const welcomeMessage=document.getElementById("welcomeMessage");
const changeNameBtn=document.getElementById("changeNameBtn");

const propertySelect=document.getElementById("propertySelect");
const addPropertyBtn=document.getElementById("addPropertyBtn");
const deletePropertyBtn=document.getElementById("deletePropertyBtn");

const monthSelect=document.getElementById("monthSelect");
const yearInput=document.getElementById("yearInput");
const prevMonthBtn=document.getElementById("prevMonthBtn");
const nextMonthBtn=document.getElementById("nextMonthBtn");

const viewMonthBtn=document.getElementById("viewMonthBtn");
const viewYearBtn=document.getElementById("viewYearBtn");
const monthView=document.getElementById("monthView");
const yearView=document.getElementById("yearView");
const calendarBody=document.getElementById("calendarBody");
const yearGrid=document.getElementById("yearGrid");
const userLegend=document.getElementById("userLegend");

/* ------------------------------------------------------
   UTILITIES
------------------------------------------------------ */
function slugify(t){
  return t.toLowerCase().trim().replace(/\s+/g,"-").replace(/[^a-z0-9\-]/g,"");
}
function formatDateKey(y,m,d){
  return `${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
}
function colourFromName(name){
  let hash=0;
  for(let i=0;i<name.length;i++){
    hash=name.charCodeAt(i)+((hash<<5)-hash);
  }
  return `hsl(${Math.abs(hash)%360},65%,75%)`;
}

/* ------------------------------------------------------
   USER INIT
------------------------------------------------------ */
function ensureUserColour(name){
  const ref=db.ref("users/"+name);
  ref.once("value",snap=>{
    if(!snap.exists()) ref.set({colour:colourFromName(name)});
  });
}

function askForName(){
  let n="";
  while(!n){
    n=prompt("Enter your name:");
    if(n===null)n="Guest";
    n=n.trim();
  }
  currentUserName=n;
  localStorage.setItem("hh_user_name",n);
  ensureUserColour(n);
  updateCurrentUserUI();
}

function initUser(){
  const stored=localStorage.getItem("hh_user_name");
  if(stored){
    currentUserName=stored;
    ensureUserColour(stored);
  } else askForName();
  updateCurrentUserUI();
}

changeNameBtn.onclick=()=>{
  const code=prompt("Admin code:");
  if(code!==ADMIN_CODE) return alert("Incorrect.");
  localStorage.removeItem("hh_user_name");
  askForName();
};

function updateCurrentUserUI(){
  userNameLabel.textContent=currentUserName;
  const c=userColours[currentUserName]?.colour || colourFromName(currentUserName);
  userColourPreview.style.background=c;
  welcomeMessage.textContent=`Hi ${currentUserName}! ðŸ¡âœ¨`;
}

/* ------------------------------------------------------
   USERS LISTENER
------------------------------------------------------ */
db.ref("users").on("value",snap=>{
  userColours=snap.val()||{};
  updateCurrentUserUI();
  renderUserLegend();
  if(viewMode==="month")renderCalendar();
  else renderYearView();
});

/* ------------------------------------------------------
   PROPERTY HANDLING
------------------------------------------------------ */
function loadProperties(){
  db.ref("properties").on("value",snap=>{
    const props=snap.val()||{};
    propertySelect.innerHTML="";

    const keys=Object.keys(props);
    if(!keys.length){
      const id="holiday-home-1";
      db.ref("properties/"+id).set({id,name:"Holiday Home"});
      return;
    }

    keys.forEach(id=>{
      const o=document.createElement("option");
      o.value=id;
      o.textContent=props[id].name;
      propertySelect.appendChild(o);
    });

    if(!currentPropertyId || !props[currentPropertyId])
      currentPropertyId=keys[0];

    propertySelect.value=currentPropertyId;
    attachBookingsListener();
  });
}

propertySelect.onchange=()=>{
  currentPropertyId=propertySelect.value;
  attachBookingsListener();
};

addPropertyBtn.onclick=()=>{
  const code=prompt("Admin code:");
  if(code!==ADMIN_CODE)return alert("Incorrect.");

  let name=prompt("New property name:");
  if(!name)return;
  name=name.trim();

  const id=slugify(name)||("prop-"+Date.now());
  db.ref("properties/"+id).set({id,name});
};

deletePropertyBtn.onclick=()=>{
  const code=prompt("Admin code:");
  if(code!==ADMIN_CODE)return alert("Incorrect.");

  if(!currentPropertyId)return;
  if(!confirm("Delete this property & its bookings?"))return;

  db.ref("properties/"+currentPropertyId).remove();
  db.ref("bookings/"+currentPropertyId).remove();
  currentPropertyId=null;
};

/* ------------------------------------------------------
   MONTH/YEAR SELECTORS
------------------------------------------------------ */
function initMonthSelector(){
  MONTH_NAMES.forEach((n,i)=>{
    const o=document.createElement("option");
    o.value=i;
    o.textContent=n;
    monthSelect.appendChild(o);
  });
  monthSelect.value=currentMonth;
  yearInput.value=currentYear;
}

monthSelect.onchange=()=>{
  currentMonth=parseInt(monthSelect.value);
  renderCalendar();
};

yearInput.onchange=()=>{
  const y=parseInt(yearInput.value);
  if(!isNaN(y)){
    currentYear=y;
    if(viewMode==="month")renderCalendar();
    else renderYearView();
  }
};

prevMonthBtn.onclick=()=>{
  currentMonth--;
  if(currentMonth<0){currentMonth=11;currentYear--;}
  monthSelect.value=currentMonth;
  yearInput.value=currentYear;
  if(viewMode==="month")renderCalendar();
  else renderYearView();
};

nextMonthBtn.onclick=()=>{
  currentMonth++;
  if(currentMonth>11){currentMonth=0;currentYear++;}
  monthSelect.value=currentMonth;
  yearInput.value=currentYear;
  if(viewMode==="month")renderCalendar();
  else renderYearView();
};

viewMonthBtn.onclick=()=>setView("month");
viewYearBtn.onclick=()=>setView("year");

function setView(v){
  viewMode=v;
  if(v==="month"){
    viewMonthBtn.classList.add("view-btn-active");
    viewYearBtn.classList.remove("view-btn-active");
    monthView.style.display="block";
    yearView.style.display="none";
    renderCalendar();
  } else {
    viewYearBtn.classList.add("view-btn-active");
    viewMonthBtn.classList.remove("view-btn-active");
    monthView.style.display="none";
    yearView.style.display="block";
    renderYearView();
  }
}

/* ------------------------------------------------------
   BOOKINGS LISTENER
------------------------------------------------------ */
function attachBookingsListener(){
  if(bookingsRef)bookingsRef.off();
  if(!currentPropertyId)return;

  bookingsRef=db.ref("bookings/"+currentPropertyId);
  bookingsRef.on("value",snap=>{
    bookings=snap.val()||{};
    if(viewMode==="month")renderCalendar();
    else renderYearView();
  });
}

/* ------------------------------------------------------
   BOOKING TOGGLE
------------------------------------------------------ */
function toggleBooking(key){
  const existing=bookings[key];
  const ref=db.ref("bookings/"+currentPropertyId+"/"+key);

  if(!existing){
    ref.set({name:currentUserName,timestamp:Date.now()});
    return;
  }

  if(existing.name===currentUserName){
    if(confirm("Cancel your booking?"))ref.remove();
    return;
  }

  if(confirm(existing.name+" already booked this. Replace?")){
    ref.set({name:currentUserName,timestamp:Date.now()});
  }
}

/* ------------------------------------------------------
   MONTH VIEW RENDER
------------------------------------------------------ */
function renderCalendar(){
  calendarBody.innerHTML="";

  const first=new Date(currentYear,currentMonth,1);
  const start=first.getDay();
  const days=new Date(currentYear,currentMonth+1,0).getDate();

  let tr=document.createElement("tr");
  for(let i=0;i<start;i++)tr.appendChild(document.createElement("td"));

  for(let d=1;d<=days;d++){
    if(tr.children.length===7){
      calendarBody.appendChild(tr);
      tr=document.createElement("tr");
    }

    const td=document.createElement("td");
    const btn=document.createElement("button");
    btn.className="day-btn";

    const key=formatDateKey(currentYear,currentMonth,d);

    const num=document.createElement("div");
    num.className="day-number";
    num.textContent=d;
    btn.appendChild(num);

    const b=bookings[key];
    if(b){
      const col=userColours[b.name]?.colour||colourFromName(b.name);
      btn.style.background=col;

      const badge=document.createElement("div");
      badge.className="booking-badge";
      badge.textContent=b.name;
      btn.appendChild(badge);
    }

    btn.onclick=()=>toggleBooking(key);
    td.appendChild(btn);
    tr.appendChild(td);
  }

  while(tr.children.length<7)tr.appendChild(document.createElement("td"));
  calendarBody.appendChild(tr);
}

/* ------------------------------------------------------
   YEAR VIEW RENDER
------------------------------------------------------ */
function renderYearView(){
  yearGrid.innerHTML="";

  for(let m=0;m<12;m++){
    const wrap=document.createElement("div");
    wrap.className="year-month";

    const title=document.createElement("div");
    title.className="year-month-title";
    title.textContent=MONTH_NAMES[m];
    wrap.appendChild(title);

    const table=document.createElement("table");
    table.className="calendar-mini";

    const thead=document.createElement("thead");
    const hr=document.createElement("tr");
    ["S","M","T","W","T","F","S"].forEach(d=>{
      const th=document.createElement("th");
      th.textContent=d;
      hr.appendChild(th);
    });
    thead.appendChild(hr);
    table.appendChild(thead);

    const tbody=document.createElement("tbody");

    const first=new Date(currentYear,m,1);
    const start=first.getDay();
    const days=new Date(currentYear,m+1,0).getDate();

    let tr=document.createElement("tr");
    for(let i=0;i<start;i++)tr.appendChild(document.createElement("td"));

    for(let d=1;d<=days;d++){
      if(tr.children.length===7){
        tbody.appendChild(tr);
        tr=document.createElement("tr");
      }

      const td=document.createElement("td");
      const btn=document.createElement("button");
      btn.className="day-btn";
      btn.textContent=d;

      const key=formatDateKey(currentYear,m,d);
      const b=bookings[key];
      if(b){
        const col=userColours[b.name]?.colour||colourFromName(b.name);
        btn.style.background=col;
      }

      btn.onclick=()=>toggleBooking(key);
      td.appendChild(btn);
      tr.appendChild(td);
    }

    while(tr.children.length<7)tr.appendChild(document.createElement("td"));
    tbody.appendChild(tr);

    table.appendChild(tbody);
    wrap.appendChild(table);
    yearGrid.appendChild(wrap);
  }
}

/* ------------------------------------------------------
   LEGEND
------------------------------------------------------ */
function renderUserLegend(){
  userLegend.innerHTML="";
  const names=Object.keys(userColours).sort();

  if(!names.length){
    userLegend.textContent="Users will appear here.";
    return;
  }

  names.forEach(n=>{
    const col=userColours[n]?.colour||colourFromName(n);
    const div=document.createElement("div");
    div.className="user-legend-item";
    div.innerHTML=
      `<span class="user-legend-swatch" style="background:${col}"></span>${n}`;
    userLegend.appendChild(div);
  });
}

/* ------------------------------------------------------
   INIT
------------------------------------------------------ */
function init(){
  initUser();
  loadProperties();
  initMonthSelector();
  setView("month");
}

init();
</script>

</body>
</html>
