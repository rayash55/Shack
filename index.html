<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ash Shack Booking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#1b4d6b">

  <link rel="manifest" href="manifest.json">
  <link rel="icon" sizes="192x192" href="icons/icon-192.png">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    body {
      margin: 0;
      font-family: "Poppins", sans-serif;
      background: #eaf0f4;
    }
    .app {
      max-width: 380px;
      margin: 0 auto;
      padding: 10px;
      min-height: 100vh;
      box-sizing: border-box;
      background:
        linear-gradient(rgba(255,255,255,0.85), rgba(255,255,255,0.92)),
        url("river-bg.jpg");
      background-size: cover;
      background-position: center;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.4);
      overflow: hidden;
    }
    h1 {
      text-align: center;
      margin: 6px 0 0 0;
      font-size: 1.3rem;
    }
    .subtitle {
      text-align: center;
      font-size: 0.8rem;
      margin-bottom: 12px;
      color: #333;
    }
    .welcome {
      text-align: center;
      font-size: 0.85rem;
      margin-bottom: 14px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      font-size: 0.85rem;
    }
    .colour-preview {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 1px solid #666;
      margin-left: 4px;
    }
    .property-bar {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 12px;
      font-size: 0.85rem;
    }
    .property-select {
      flex: 1;
      padding: 6px;
      font-size: 0.85rem;
      border-radius: 8px;
    }
    .prop-mini-btn {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      border: 1px solid #aaa;
      background: rgba(255,255,255,0.7);
      font-size: 16px;
      font-weight: 600;
      padding: 0;
      cursor: pointer;
    }
    .prop-del {
      background: rgba(255,200,200,0.6);
      border-color: #bb7777;
      color: #a33;
    }
    .month-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 0.8rem;
    }
    .month-center {
      display: flex;
      gap: 4px;
    }
    .month-select, .year-input {
      padding: 4px;
      font-size: 0.8rem;
    }
    .year-input {
      width: 60px;
    }
    .view-toggle {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 10px;
    }
    .view-btn {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      border: 1px solid #999;
      background: rgba(255,255,255,0.7);
      cursor: pointer;
    }
    .view-btn-active {
      background: #0078ff;
      color: #fff;
      border-color: #0078ff;
    }
    .calendar {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
    }
    .calendar th {
      color: #222;
    }
    .calendar td {
      height: 42px;
      border: 1px solid rgba(0,0,0,0.12);
      background: rgba(255,255,255,0.25);
      backdrop-filter: blur(3px);
      padding: 0;
    }
    .day-btn {
      width: 100%;
      height: 100%;
      background: transparent;
      border: none;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      cursor: pointer;
    }
    .day-number {
      font-weight: 600;
      font-size: 0.85rem;
    }
    .booking-badge {
      font-size: 0.6rem;
      padding: 2px 4px;
      border-radius: 999px;
      background: rgba(255,255,255,0.7);
    }
    #yearView { display: none; }
    .year-grid {
      display: grid;
      grid-template-columns: repeat(2,1fr);
      gap: 6px;
    }
    .year-month {
      padding: 4px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.4);
      background: rgba(255,255,255,0.4);
    }
    .year-month-title {
      text-align: center;
      font-size: 0.7rem;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .calendar-mini td {
      height: 24px;
      background: rgba(255,255,255,0.25);
      border: 1px solid rgba(0,0,0,0.12);
      padding: 0;
    }
    .user-legend {
      margin-top: 10px;
      text-align: center;
      font-size: 0.75rem;
    }
    .user-legend-item {
      display: inline-flex;
      align-items: center;
      margin: 0 6px;
    }
    .user-legend-swatch {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 4px;
      border: 1px solid #666;
    }
  </style>
</head>
<body>
<div class="app">
  <h1>Ash Shack Booking</h1>
  <div class="subtitle">Tap a day to book it.</div>
  <div id="welcomeMessage" class="welcome"></div>

  <div class="top-bar">
    <div>You: <span id="userNameLabel"></span> <span id="userColourPreview" class="colour-preview"></span></div>
    <button id="changeNameBtn">Change</button>
  </div>

  <div class="property-bar">
    <span>Property:</span>
    <select id="propertySelect" class="property-select"></select>
    <button id="addPropertyBtn" class="prop-mini-btn">+</button>
    <button id="deletePropertyBtn" class="prop-mini-btn prop-del">âˆ’</button>
  </div>

  <div class="month-nav">
    <button id="prevMonthBtn">â—€</button>
    <div class="month-center">
      <select id="monthSelect" class="month-select"></select>
      <input id="yearInput" class="year-input" type="number">
    </div>
    <button id="nextMonthBtn">â–¶</button>
  </div>

  <div class="view-toggle">
    <button id="viewMonthBtn" class="view-btn view-btn-active">Month</button>
    <button id="viewYearBtn" class="view-btn">Year</button>
  </div>

  <div id="monthView">
    <table class="calendar">
      <thead>
        <tr>
          <th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>
        </tr>
      </thead>
      <tbody id="calendarBody"></tbody>
    </table>
  </div>

  <div id="yearView">
    <div class="year-grid" id="yearGrid"></div>
  </div>

  <div id="userLegend" class="user-legend"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const ADMIN_CODE = "1746";

firebase.initializeApp({
  apiKey: "AIzaSyDXdfo2XI7xuHs3LOc6q4CbVpMudHfBTCs",
  authDomain: "ash-shack.firebaseapp.com",
  databaseURL: "https://ash-shack-default-rtdb.firebaseio.com",
  projectId: "ash-shack",
  storageBucket: "ash-shack.firebasestorage.app",
  messagingSenderId: "7831464900",
  appId: "1:7831464900:web:18f1c72f0c37f667005291"
});
const db = firebase.database();

let currentUserName = null;
let currentPropertyId = null;
let bookingsRef = null;
let bookings = {};
let userColours = {};
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth();
let viewMode = "month";

const MONTH_NAMES = [
  "January","February","March","April","May","June",
  "July","August","September","October","November","December"
];

const userNameLabel = document.getElementById("userNameLabel");
const userColourPreview = document.getElementById("userColourPreview");
const welcomeMessage = document.getElementById("welcomeMessage");
const changeNameBtn = document.getElementById("changeNameBtn");
const propertySelect = document.getElementById("propertySelect");
const addPropertyBtn = document.getElementById("addPropertyBtn");
const deletePropertyBtn = document.getElementById("deletePropertyBtn");
const monthSelect = document.getElementById("monthSelect");
const yearInput = document.getElementById("yearInput");
const prevMonthBtn = document.getElementById("prevMonthBtn");
const nextMonthBtn = document.getElementById("nextMonthBtn");
const viewMonthBtn = document.getElementById("viewMonthBtn");
const viewYearBtn = document.getElementById("viewYearBtn");
const monthView = document.getElementById("monthView");
const yearView = document.getElementById("yearView");
const calendarBody = document.getElementById("calendarBody");
const yearGrid = document.getElementById("yearGrid");
const userLegend = document.getElementById("userLegend");

function slugify(t){
  return t.toLowerCase().trim().replace(/\s+/g,"-").replace(/[^a-z0-9\-]/g,"");
}
function formatDateKey(y,m,d){
  return y + "-" + String(m+1).padStart(2,"0") + "-" + String(d).padStart(2,"0");
}
function colourFromName(name){
  let h = 0;
  for(let i=0;i<name.length;i++) h = name.charCodeAt(i)+((h<<5)-h);
  return "hsl(" + (Math.abs(h)%360) + ",65%,75%)";
}

function ensureUserColour(name){
  const ref = db.ref("users/"+name);
  ref.once("value",snap=>{
    if(!snap.exists()) ref.set({colour:colourFromName(name)});
  });
}

function askForName(){
  let n = "";
  while(!n){
    n = prompt("Enter your name:") || "Guest";
    n = n.trim();
  }
  currentUserName = n;
  localStorage.setItem("hh_user_name", n);
  ensureUserColour(n);
  updateUserUI();
}

function initUser(){
  const stored = localStorage.getItem("hh_user_name");
  if(stored){
    currentUserName = stored;
    ensureUserColour(stored);
  } else {
    askForName();
  }
  updateUserUI();
}

function updateUserUI(){
  userNameLabel.textContent = currentUserName || "";
  const col = userColours[currentUserName]?.colour || colourFromName(currentUserName || "");
  userColourPreview.style.background = col;
  welcomeMessage.textContent = currentUserName ? ("Hi " + currentUserName + "! ðŸ¡âœ¨") : "";
}

changeNameBtn.onclick = () => {
  const code = prompt("Admin code:");
  if(code !== ADMIN_CODE) return alert("Incorrect.");
  localStorage.removeItem("hh_user_name");
  askForName();
};

db.ref("users").on("value",snap=>{
  userColours = snap.val() || {};
  updateUserUI();
  renderLegend();
  if(viewMode==="month") renderCalendar();
  else renderYear();
});

function loadProperties(){
  db.ref("properties").on("value",snap=>{
    const props = snap.val() || {};
    propertySelect.innerHTML = "";
    const keys = Object.keys(props);
    if(!keys.length){
      const id = "default";
      db.ref("properties/"+id).set({id, name:"Holiday Home"});
      return;
    }
    keys.forEach(id=>{
      const o = document.createElement("option");
      o.value = id;
      o.textContent = props[id].name;
      propertySelect.appendChild(o);
    });
    if(!currentPropertyId || !props[currentPropertyId]) currentPropertyId = keys[0];
    propertySelect.value = currentPropertyId;
    attachBookings();
  });
}

propertySelect.onchange = () => {
  currentPropertyId = propertySelect.value;
  attachBookings();
};

addPropertyBtn.onclick = () => {
  const code = prompt("Admin code:");
  if(code !== ADMIN_CODE) return alert("Incorrect.");
  let n = prompt("New property name:");
  if(!n) return;
  n = n.trim();
  const id = slugify(n) || ("prop-" + Date.now());
  db.ref("properties/"+id).set({id, name:n});
};

deletePropertyBtn.onclick = () => {
  const code = prompt("Admin code:");
  if(code !== ADMIN_CODE) return alert("Incorrect.");
  if(!currentPropertyId) return;
  if(!confirm("Delete this property and all bookings?")) return;
  db.ref("properties/"+currentPropertyId).remove();
  db.ref("bookings/"+currentPropertyId).remove();
};

function attachBookings(){
  if(bookingsRef) bookingsRef.off();
  bookingsRef = db.ref("bookings/"+currentPropertyId);
  bookingsRef.on("value",snap=>{
    bookings = snap.val() || {};
    if(viewMode==="month") renderCalendar();
    else renderYear();
  });
}

function toggleBooking(key){
  const existing = bookings[key];
  const ref = db.ref("bookings/"+currentPropertyId+"/"+key);
  if(!existing){
    ref.set({name:currentUserName});
    return;
  }
  if(existing.name === currentUserName){
    if(confirm("Cancel your booking?")) ref.remove();
    return;
  }
  if(confirm(existing.name + " booked this. Replace?")){
    ref.set({name:currentUserName});
  }
}

function initMonthSelector(){
  MONTH_NAMES.forEach((n,i)=>{
    const o = document.createElement("option");
    o.value = i;
    o.textContent = n;
    monthSelect.appendChild(o);
  });
  monthSelect.value = currentMonth;
  yearInput.value = currentYear;

  monthSelect.onchange = () => {
    currentMonth = parseInt(monthSelect.value, 10);
    renderCalendar();
  };
  yearInput.onchange = () => {
    currentYear = parseInt(yearInput.value, 10);
    if(viewMode==="month") renderCalendar();
    else renderYear();
  };
  prevMonthBtn.onclick = () => {
    currentMonth--;
    if(currentMonth < 0){ currentMonth = 11; currentYear--; }
    monthSelect.value = currentMonth;
    yearInput.value = currentYear;
    if(viewMode==="month") renderCalendar();
    else renderYear();
  };
  nextMonthBtn.onclick = () => {
    currentMonth++;
    if(currentMonth > 11){ currentMonth = 0; currentYear++; }
    monthSelect.value = currentMonth;
    yearInput.value = currentYear;
    if(viewMode==="month") renderCalendar();
    else renderYear();
  };
  viewMonthBtn.onclick = () => {
    viewMode = "month";
    viewMonthBtn.classList.add("view-btn-active");
    viewYearBtn.classList.remove("view-btn-active");
    monthView.style.display = "block";
    yearView.style.display = "none";
    renderCalendar();
  };
  viewYearBtn.onclick = () => {
    viewMode = "year";
    viewYearBtn.classList.add("view-btn-active");
    viewMonthBtn.classList.remove("view-btn-active");
    monthView.style.display = "none";
    yearView.style.display = "block";
    renderYear();
  };
}

function renderCalendar(){
  calendarBody.innerHTML = "";
  const first = new Date(currentYear,currentMonth,1);
  const start = first.getDay();
  const days = new Date(currentYear,currentMonth+1,0).getDate();

  let tr = document.createElement("tr");
  for(let i=0;i<start;i++) tr.appendChild(document.createElement("td"));

  for(let d=1;d<=days;d++){
    if(tr.children.length === 7){
      calendarBody.appendChild(tr);
      tr = document.createElement("tr");
    }
    const td = document.createElement("td");
    const btn = document.createElement("button");
    btn.className = "day-btn";

    const num = document.createElement("div");
    num.className = "day-number";
    num.textContent = d;
    btn.appendChild(num);

    const key = formatDateKey(currentYear,currentMonth,d);
    const b = bookings[key];
    if(b){
      const col = userColours[b.name]?.colour || colourFromName(b.name);
      btn.style.background = col;
      const badge = document.createElement("div");
      badge.className = "booking-badge";
      badge.textContent = b.name;
      btn.appendChild(badge);
    }

    btn.onclick = () => toggleBooking(key);
    td.appendChild(btn);
    tr.appendChild(td);
  }

  while(tr.children.length < 7) tr.appendChild(document.createElement("td"));
  calendarBody.appendChild(tr);
}

function renderYear(){
  yearGrid.innerHTML = "";
  for(let m=0;m<12;m++){
    const box = document.createElement("div");
    box.className = "year-month";

    const title = document.createElement("div");
    title.className = "year-month-title";
    title.textContent = MONTH_NAMES[m];
    box.appendChild(title);

    const table = document.createElement("table");
    table.className = "calendar-mini";

    const thead = document.createElement("thead");
    const trh = document.createElement("tr");
    ["S","M","T","W","T","F","S"].forEach(d=>{
      const th = document.createElement("th");
      th.textContent = d;
      trh.appendChild(th);
    });
    thead.appendChild(trh);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    const first = new Date(currentYear,m,1);
    const start = first.getDay();
    const days = new Date(currentYear,m+1,0).getDate();

    let tr = document.createElement("tr");
    for(let i=0;i<start;i++) tr.appendChild(document.createElement("td"));

    for(let d=1;d<=days;d++){
      if(tr.children.length === 7){
        tbody.appendChild(tr);
        tr = document.createElement("tr");
      }
      const td = document.createElement("td");
      const btn = document.createElement("button");
      btn.className = "day-btn";
      btn.textContent = d;

      const key = formatDateKey(currentYear,m,d);
      const b = bookings[key];
      if(b){
        const col = userColours[b.name]?.colour || colourFromName(b.name);
        btn.style.background = col;
      }

      btn.onclick = () => toggleBooking(key);
      td.appendChild(btn);
      tr.appendChild(td);
    }

    while(tr.children.length < 7) tr.appendChild(document.createElement("td"));
    tbody.appendChild(tr);
    table.appendChild(tbody);
    box.appendChild(table);
    yearGrid.appendChild(box);
  }
}

function renderLegend(){
  userLegend.innerHTML = "";
  const names = Object.keys(userColours).sort();
  names.forEach(n=>{
    const col = userColours[n]?.colour || colourFromName(n);
    const span = document.createElement("span");
    span.className = "user-legend-item";
    span.innerHTML = '<span class="user-legend-swatch" style="background:'+col+'"></span>' + n;
    userLegend.appendChild(span);
  });
}

function init(){
  initUser();
  loadProperties();
  initMonthSelector();
  renderCalendar();

  if ("serviceWorker" in navigator){
    window.addEventListener("load", function(){
      navigator.serviceWorker.register("service-worker.js").catch(console.error);
    });
  }
}
init();
</script>
</body>
</html>
